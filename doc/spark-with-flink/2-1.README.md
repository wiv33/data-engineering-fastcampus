# 2-1 병렬처리와 분산처리

# 1. 병렬처리와 분산처리 및 latency

스파크는 분산 환경에서 병렬 처리로 동작하기 때문에
작성하는 코드가 클러스터에서 어떻게 동작할지 이해하고 코딩을 작성해야 한다.

ex) `reduceByKey`는 각 클러스터 연산을 합치는 동작을 하기 때문에 `클러스터 네트워크 통신`을 한다.

1. RDD.map(A)`.reduceByKey(C)`.filter(B)
2. RDD.map(A).filter(B)`.reduceByKey(C)`

# 3. key-value RDD

함수의 반환 값이 여러 개인 경우 key-value RDD가 된다.

ex)

```python
# python
pairs = rdd.map(lambda x: (x, 1))
```

key value RDD

- 넷플릭스 드라마가 받은 평균 별점(날짜, 승객 수)
- 지역 id 별로 택시 `운행 수`
    - key: 지역 ID
    - value: 운행 수
- 드라마 별로 `별점 수` 모아보기, `평균` 구하기
    - key: 드라마 id
    - value: 별점 수
    - value: 평균
- 이커머스 사이트에서 상품당 `별 평점` 구하기

single value RDD

- 텍스트에 등장하는 단어 수 세기 (날짜)

## reduction function

    `key`가 변경되지 않는 경우 ~~.map()~~ -> `mapValues()` 활용.
    spark 내부적으로 파티션을 유지하여 효율이 증가

    `mapValues()`
    `flatMapValues()`

- reduceByKey()
    - key 값을 기준으로 accumulate 함
- groupByKey()
    - key 값을 기준으로 값을 그룹화
- sortByKey()
    - 키 값을 기준으로 정렬
- keys()
    - 키 추출
- values()
    - 값 추출
- db와 같은 기능
    - join()
    - rightOuterJoin()
    - leftOuterJoin()
    - subtractByKey()

## 실습

[restaurant_reviews](../../src/main/scala/_01/CategoryReviewAverage.py)

# 4. transformations and actions

Spark operation = transformations + actions의 연산

`transformation`

- `지연 실행`: lazy execution
- 중단 연산
- 새로운 RDD 객체 반환

`actions`

- `즉시 실행`: eager execution
- 종단 연산
- list, map과 같은 자료형으로 변환

## transformations functions

- map
- flatMap
- filter
- distinct
- reduceByKey
- groupByKey
- mapValues
- flatMapValues
- sortByKey
- ...

## Actions
- collect
- count
- countByValue
- take
- top
- reduce
- fold
- foreach
- ...


    foreach는 worker 노드에서만 동작하기 때문에
    master node console에서 실행해도 눈으로 볼 수 없음

    (pycharm은 볼 수 있었음.)

## Narrow transformation
1:1 변환

1개의 열을 조작하기 위해 다른 열이나 파티션의 데이터를 사용할 필요가 없다. `(다른 데이터가 들어가지 않는다.)`

정렬이 필요하지 않은 경우 사용

비교가 발생하면 클러스터간 통신이 일어남

- filter
- map
- flatMap
- sample
- union
- ...

## Wide Transformation
최종 반환되는 RDD 파티션에 다른 파티션 데이터가 `들어갈 수 있음`

**많은 리소스와 통신을 필요로 한다.**

- shuffling
- intersection
- join
- distinct
- cartesian
- reduceByKey
- groupByKey



### 실습
[rdd_transformations_actions](../../src/main/scala/_01/rdd_transformation_actions.ipynb)
